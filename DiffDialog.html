<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; background: #f7f9fa; margin: 0; padding: 0; }
    .dialog-main {
      max-width: 800px;
      margin: 32px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      padding: 28px 36px 24px 36px;
      position: relative;
    }
    .close { position: absolute; top: 20px; right: 28px; font-weight: bold; cursor: pointer; font-size: 28px; color: #888; }
    h3 { margin-top: 0; color: #1565c0; letter-spacing: .5px; }
    .meta {
      margin-bottom: 20px;
      font-size: 15px;
      color: #444;
      line-height: 1.6;
      background: #e3f2fd;
      border-radius: 8px;
      padding: 12px;
    }
    table.diff {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0 0 0;
      font-size: 15px;
    }
    .diff th, .diff td {
      padding: 8px;
      border: 1px solid #e0e0e0;
      transition: background 0.12s;
    }
    .diff th {
      background: #f2f7fc;
      font-weight: 600;
      color: #1565c0;
    }
    .diff td {
      background: #fff;
      cursor: pointer;
    }
    .diff tr:hover td { background: #e3f2fd; }
    .diff td.highlight-col { background: #e1bee7 !important; }
    .diff td.highlight-row { background: #fff9c4 !important; }
    .old {
      color: #c62828;
      background: #ffebee;
      padding: 3px 6px;
      border-radius: 3px;
      font-weight: 500;
      margin-bottom: 2px;
    }
    .new {
      color: #2e7d32;
      background: #e8f5e9;
      padding: 3px 6px;
      border-radius: 3px;
      font-weight: 500;
      margin-top: 2px;
    }
    .unchanged { color: #666; }
    .cell-tooltip {
      position: fixed;
      background: #333;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.14s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }
    @media (max-width: 600px) {
      .dialog-main { padding: 10px 2vw; }
      table.diff { font-size: 13px; }
      .meta { font-size: 13px; }
    }
  </style>
</head>
<body>
  <div class="dialog-main">
    <span class="close" onclick="google.script.host.close()">✕</span>
    <h3>Сравнение изменений</h3>
    <div class="meta" id="meta"></div>
    <table class="diff" id="diffTable"></table>
    <div class="cell-tooltip" id="tooltip"></div>
  </div>
  <script>
    google.script.run.withSuccessHandler(renderDiff).getLogEntry_();

    function renderDiff(data) {
      document.getElementById('meta').innerHTML = `
        <b>Файл:</b> ${escapeHtml(data.file)} &nbsp; | &nbsp; <b>Лист:</b> ${escapeHtml(data.sheet)} &nbsp; | &nbsp; <b>Ячейка:</b> ${escapeHtml(data.cell)}<br>
        <b>Время:</b> ${escapeHtml(data.timestamp)} &nbsp; | &nbsp; <b>Пользователь:</b> ${escapeHtml(data.user)}
      `;

      const table = document.getElementById('diffTable');
      if (data.isRange) {
        let oldGrid, newGrid;
        try {
          oldGrid = JSON.parse(data.oldValue);
        } catch { oldGrid = []; }
        try {
          newGrid = JSON.parse(data.newValue);
        } catch { newGrid = []; }
        const maxR = Math.max(oldGrid.length, newGrid.length);
        const maxC = Math.max(
          oldGrid.reduce((a, b) => Math.max(a, b?.length||0), 0),
          newGrid.reduce((a, b) => Math.max(a, b?.length||0), 0)
        );

        let html = '<tr><th></th>';
        for (let c = 0; c < maxC; c++) html += `<th>${String.fromCharCode(65 + c)}</th>`;
        html += '</tr>';

        for (let r = 0; r < maxR; r++) {
          html += `<tr><td>${r + 1}</td>`;
          for (let c = 0; c < maxC; c++) {
            const oldCell = (oldGrid[r] && oldGrid[r][c]) !== undefined ? oldGrid[r][c] : '';
            const newCell = (newGrid[r] && newGrid[r][c]) !== undefined ? newGrid[r][c] : '';
            let cellHtml = "";
            if (oldCell === newCell) {
              cellHtml = `<span class="unchanged">${escapeHtml(oldCell)}</span>`;
            } else {
              cellHtml = `<span class="old" title="Было">${escapeHtml(oldCell)}</span><br><span class="new" title="Стало">${escapeHtml(newCell)}</span>`;
            }
            html += `<td data-row="${r}" data-col="${c}" data-old="${escapeAttr(oldCell)}" data-new="${escapeAttr(newCell)}">${cellHtml}</td>`;
          }
          html += '</tr>';
        }
        table.innerHTML = html;
        enableCellFeatures();
      } else {
        table.innerHTML = `
          <tr><th>Было</th><td><span class="old" title="Было">${escapeHtml(data.oldValue)}</span></td></tr>
          <tr><th>Стало</th><td><span class="new" title="Стало">${escapeHtml(data.newValue)}</span></td></tr>
        `;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    function escapeAttr(text) {
      return String(text).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // Highlight row/col on hover & cell tooltip/copy
    function enableCellFeatures() {
      const table = document.getElementById('diffTable');
      const tooltip = document.getElementById('tooltip');
      table.querySelectorAll('td').forEach(cell => {
        cell.addEventListener('mouseenter', function(e) {
          const col = +this.dataset.col;
          const row = +this.dataset.row;
          table.querySelectorAll(`[data-col="${col}"]`).forEach(td => td.classList.add('highlight-col'));
          table.querySelectorAll(`[data-row="${row}"]`).forEach(td => td.classList.add('highlight-row'));

          let text = `Строка: ${row+1}, Столбец: ${String.fromCharCode(65+col)}`;
          if (this.dataset.old !== this.dataset.new)
            text += `<br><span style="color:#c62828">Было:</span> ${escapeHtml(this.dataset.old)}<br><span style="color:#2e7d32">Стало:</span> ${escapeHtml(this.dataset.new)}`;
          else
            text += `<br>${escapeHtml(this.dataset.old)}`;
          tooltip.innerHTML = text;
          tooltip.style.opacity = 1;
          positionTooltip(e, tooltip);
        });
        cell.addEventListener('mousemove', function(e) {
          positionTooltip(e, tooltip);
        });
        cell.addEventListener('mouseleave', function() {
          tooltip.style.opacity = 0;
          table.querySelectorAll('.highlight-col').forEach(td => td.classList.remove('highlight-col'));
          table.querySelectorAll('.highlight-row').forEach(td => td.classList.remove('highlight-row'));
        });
        // Копировать значение ячейки по клику
        cell.addEventListener('click', function() {
          const value = this.dataset.new || this.dataset.old || '';
          if (navigator.clipboard) {
            navigator.clipboard.writeText(value);
            showToast(`Значение "${value}" скопировано!`);
          }
        });
      });
    }

    function positionTooltip(e, tooltip) {
      const pad = 12;
      let x = e.clientX + pad;
      let y = e.clientY + pad;
      const rect = tooltip.getBoundingClientRect();
      if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - pad;
      if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - pad;
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
    }

    // Toast уведомление
    function showToast(msg) {
      let toast = document.getElementById('toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.position = 'fixed';
        toast.style.bottom = '34px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = '#1565c0';
        toast.style.color = '#fff';
        toast.style.fontSize = '15px';
        toast.style.padding = '9px 22px';
        toast.style.borderRadius = '7px';
        toast.style.zIndex = '9999';
        toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.12)';
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.18s';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.style.opacity = '1';
      setTimeout(() => { toast.style.opacity = '0'; }, 1600);
    }
  </script>
</body>
</html>
