# Implementation Plan

- [x] 1. Створити конфігурацію та головну функцію


  - Створити константу `CONFIG` з ID таблиць, назвами листів та параметрами
  - Реалізувати функцію `copyETSDataToRebHistory()` з LockService та обробкою помилок
  - Додати логування для відстеження виконання
  - _Requirements: 1.1, 1.3, 1.5_



- [ ] 2. Реалізувати функцію копіювання об'єднаних ячейок
  - Створити функцію `copyMergedCells(sourceSheet, sourceRange, targetSheet, targetStartRow, targetStartCol)`
  - Отримати список об'єднаних ячейок через `sourceRange.getMergedRanges()`
  - Обчислити відносні позиції об'єднань відносно вихідного діапазону
  - Створити відповідні об'єднання в цільовому діапазоні
  - Додати обробку помилок для випадків, коли API недоступний


  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 3. Модифікувати функцію копіювання з порівнянням
  - Створити нову версію `copyTableWithDiffAndMerge()` на базі існуючої `copyTableWithDiff()`
  - Визначити використаний діапазон динамічно через `getDataRange()`
  - Додати виклик `copyMergedCells()` після вставки даних


  - Зберегти існуючу логіку порівняння значень (починаючи з індексу j=2)
  - Зберегти існуючу логіку форматування процентів для останнього стовпця
  - _Requirements: 1.1, 1.2, 2.1, 3.2, 3.6, 4.1, 4.2, 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 4. Реалізувати логіку порівняння з візуалізацією
  - Використати існуючу функцію `findPrevBlockTop()` для пошуку попереднього блоку
  - Реалізувати цикл порівняння значень (пропускаючи перші два стовпці)


  - Застосувати форматування для зростання: `[число] ↑ +[різниця]` з фоном `#d4edda`
  - Застосувати форматування для зменшення: `[число] ↓ [різниця]` з фоном `#f8d7da`
  - Залишити без змін значення, які не змінилися
  - Використати існуючі функції `toNum()` та `formatVal()`
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 5.1, 5.2, 5.3, 5.4, 5.5_




- [ ] 5. Створити функцію управління тригером
  - Реалізувати функцію `createDailyTrigger()`
  - Видалити всі існуючі тригери для `copyETSDataToRebHistory`
  - Створити новий щоденний тригер на 17:00 за київським часом
  - Використати `.timeBased().atHour(17).everyDays(1).inTimezone('Europe/Kiev')`
  - _Requirements: 1.4_

- [ ] 6. Інтегрувати новий код з існуючим скриптом
  - Додати новий код в існуючий файл `.gs`
  - Переконатися, що utility функції (`toNum`, `formatVal`, `findPrevBlockTop`, `isDateStamp`) доступні для нового коду
  - Перевірити, що новий код не конфліктує з існуючим функціоналом `copyATDataToHistory`
  - Додати коментарі для розділення різних функціональностей
  - _Requirements: 5.5_

- [ ]* 7. Створити тестові сценарії
  - Написати тестову функцію для перевірки `copyMergedCells()` з різними типами об'єднань
  - Написати тестову функцію для перевірки порівняння значень (зростання, зменшення, без змін)
  - Написати тестову функцію для перевірки форматування процентів
  - Створити тестову таблицю з відомими даними для інтеграційного тестування
  - _Requirements: 2.1, 3.3, 3.4, 3.5, 4.2_

- [ ]* 8. Виконати інтеграційне тестування
  - Створити тестові таблиці з реалістичними даними
  - Запустити `copyETSDataToRebHistory()` вручну та перевірити результат
  - Перевірити збереження об'єднаних ячейок візуально
  - Перевірити правильність підсвітки змін (зелений/червоний)
  - Запустити двічі та перевірити порівняння з попереднім блоком
  - Перевірити роботу LockService при одночасних запусках
  - _Requirements: 1.5, 2.1, 3.3, 3.4, 3.5_
